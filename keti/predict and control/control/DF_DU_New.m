%***********************************************************************
% function vout = DF_DU_New(x,u,v,W1,W2)
%       x:模型输入状态变量；
%       u:模型输入控制量；
%       v:模型输入扰动变量
%       W1：模型隐层到输入层权值矩阵（含阈值）；
%       W2：模型输出层到隐层层权值矩阵（含阈值）；
%       修订日期：2017-07-14
%       作者：Yibing Ran
% ------------------修订---------------------------------------
%-       修订日期：2017-08-17
%        作者：冉义兵
%        功能：激活函数purelin该为logsig

function vout = DF_DU_New(x,u,v,W1,W2)
    A=cat(1,x,u,v,1);             %输入向量
    S1=W1*A;                      %隐层-输入线性求和
    B=tansig(S1);                 %第一层(隐藏)神经元的输出
    [q,p]=size(W2);               %p:隐层节点数  
    B(p)=1;                      %隐层阈值(工具箱训练模型)
    S2=W2*B;                      %输出-隐层线性求和
    dB_dS1=4*exp(-2*S1)./(1+exp(-2*S1)).^2;
    df_dS2=exp(-S2)./(1+exp(-S2)).^2;
    nx=length(x);
    nu=length(u);
    W1=W1(:,nx+1:nx+nu);      %W1_PM=W1_PM(:,Nx+1:Nx+Nu);
    W2=W2(:,1:p-1);
%     vout=W2*diag(dB_dS1)*W1;
    vout=((diag(df_dS2)*W2))*(diag(dB_dS1)*W1);
    
    

